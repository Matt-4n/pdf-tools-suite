<!DOCTYPE html>
<html>
<head>
    <title>PDF Processor</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .info-box { background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2196f3; }
        .upload-area { border: 2px dashed #ccc; padding: 40px; text-align: center; margin: 20px 0; cursor: pointer; border-radius: 10px; transition: all 0.3s; }
        .upload-area:hover { border-color: #007bff; background: #f8f9fa; }
        .upload-area.dragover { border-color: #28a745; background: #f0fff4; transform: scale(1.02); }
        button { background: #007bff; color: white; padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; transition: all 0.3s; }
        button:hover { background: #0056b3; transform: translateY(-1px); }
        button:disabled { background: #6c757d; cursor: not-allowed; transform: none; }
        .file-item { background: #f8f9fa; padding: 12px; margin: 8px 0; border-radius: 6px; border-left: 4px solid #007bff; display: flex; justify-content: space-between; align-items: center; }
        .status { margin: 20px 0; padding: 15px; border-radius: 8px; font-weight: 500; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.loading { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .feature-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .feature { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
        .signature-status { display: inline-block; padding: 5px 12px; border-radius: 15px; font-size: 14px; font-weight: 500; }
        .signature-ready { background: #d4edda; color: #155724; }
        .signature-missing { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã PDF Processor</h1>
            <p>Declaration at Import - Automatic Form Filling & Compression</p>
            <div id="signatureStatus"></div>
        </div>
        
        <div class="info-box">
            <strong>üöÄ What this does:</strong><br>
            ‚Ä¢ Extracts shipment data from your first PDF<br>
            ‚Ä¢ Fills Declaration at Import forms automatically<br>
            ‚Ä¢ Adds your signature to all documents<br>
            ‚Ä¢ Compresses files to under 1.1MB<br>
            ‚Ä¢ Processes up to 30+ PDFs in one batch
        </div>
        
        <div class="upload-area" id="uploadArea">
            <h3>üìÅ Upload PDF Files</h3>
            <p>Drag and drop your Declaration at Import PDFs here<br>
            <small>or click to browse ‚Ä¢ Supports multiple files ‚Ä¢ Max 50MB per file</small></p>
            <input type="file" id="fileInput" multiple accept=".pdf" style="display: none;">
        </div>
        
        <div id="fileList"></div>
        
        <button onclick="processFiles()" id="processBtn" disabled>
            üöÄ Process All Documents
        </button>
        
        <div id="status"></div>
    </div>
    
    <script>
        let selectedFiles = [];
        let signatureAvailable = false;
        
        // Check signature status on load
        fetch("/api/health")
            .then(response => response.json())
            .then(data => {
                signatureAvailable = data.signatureAvailable;
                updateSignatureStatus();
            });
        
        function updateSignatureStatus() {
            const statusDiv = document.getElementById("signatureStatus");
            if (signatureAvailable) {
                statusDiv.innerHTML = `<span class="signature-status signature-ready">‚úçÔ∏è Signature Ready</span>`;
            } else {
                statusDiv.innerHTML = `<span class="signature-status signature-missing">‚ö†Ô∏è Signature Missing</span>`;
            }
        }
        
        // File handling
        const uploadArea = document.getElementById("uploadArea");
        const fileInput = document.getElementById("fileInput");
        
        uploadArea.addEventListener("click", () => fileInput.click());
        
        uploadArea.addEventListener("dragover", (e) => {
            e.preventDefault();
            uploadArea.classList.add("dragover");
        });
        
        uploadArea.addEventListener("dragleave", () => {
            uploadArea.classList.remove("dragover");
        });
        
        uploadArea.addEventListener("drop", (e) => {
            e.preventDefault();
            uploadArea.classList.remove("dragover");
            const files = Array.from(e.dataTransfer.files).filter(f => f.type === "application/pdf");
            handleFiles(files);
        });
        
        fileInput.addEventListener("change", (e) => {
            handleFiles(Array.from(e.target.files));
        });
        
        function handleFiles(files) {
            selectedFiles = files;
            updateFileList();
        }
        
        function updateFileList() {
            const fileList = document.getElementById("fileList");
            const processBtn = document.getElementById("processBtn");
            
            if (selectedFiles.length > 0) {
                fileList.innerHTML = `<h4>üìã Selected Files (${selectedFiles.length}):</h4>` + 
                    selectedFiles.map((f, i) => 
                        `<div class="file-item">
                            <span>üìÑ ${f.name}</span>
                            <span>${(f.size/1024/1024).toFixed(2)} MB</span>
                         </div>`
                    ).join("");
                processBtn.disabled = false;
            } else {
                fileList.innerHTML = "";
                processBtn.disabled = true;
            }
        }
        
        async function processFiles() {
            const statusDiv = document.getElementById("status");
            const processBtn = document.getElementById("processBtn");
            
            if (selectedFiles.length === 0) return;
            
            try {
                processBtn.disabled = true;
                statusDiv.innerHTML = `<div class="status loading">üì§ Uploading ${selectedFiles.length} files...</div>`;
                
                // Upload files
                const formData = new FormData();
                selectedFiles.forEach(file => {
                    formData.append("pdfs", file);
                });
                
                const uploadResponse = await fetch("/api/upload", {
                    method: "POST",
                    body: formData
                });
                
                const uploadResult = await uploadResponse.json();
                
                if (uploadResult.success) {
                    statusDiv.innerHTML = `<div class="status loading">
                        üîÑ Processing files with text overlays and signature...<br>
                        <small>This may take a few moments for ${selectedFiles.length} files</small>
                    </div>`;
                    
                    // Process files
                    const processResponse = await fetch("/api/process", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ sessionId: uploadResult.sessionId })
                    });
                    
                    const processResult = await processResponse.json();
                    
                    if (processResult.success) {
                        statusDiv.innerHTML = `<div class="status success">
                            ‚úÖ Processing Complete!<br>
                            üìä ${processResult.successful} of ${processResult.processed} files processed successfully<br>
                            <small>Files include text overlays, signature, and compression under 1.1MB</small>
                        </div>`;
                    } else {
                        statusDiv.innerHTML = `<div class="status error">‚ùå Processing failed: ${processResult.error}</div>`;
                    }
                } else {
                    statusDiv.innerHTML = `<div class="status error">‚ùå Upload failed: ${uploadResult.error}</div>`;
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            } finally {
                processBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
