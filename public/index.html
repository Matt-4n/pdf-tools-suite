<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Processor & Merger Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 5px;
            backdrop-filter: blur(10px);
        }

        .nav-tab {
            flex: 1;
            max-width: 250px;
            padding: 15px 25px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            color: white;
            font-weight: 600;
            text-decoration: none;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: white;
            color: #4f46e5;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* Content Panels */
        .content-panel {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            padding: 40px;
            display: none;
        }

        .content-panel.active {
            display: block;
        }

        /* Form Processor Styles (your existing styles) */
        .step {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px dashed #e0e7ff;
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .step.active {
            border-color: #4f46e5;
            background: #f8faff;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            background: #4f46e5;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .step-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1f2937;
        }

        /* Upload Areas */
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #4f46e5;
            background: #f8faff;
        }

        .upload-area.dragover {
            border-color: #4f46e5;
            background: #e0e7ff;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.6;
        }

        /* File Lists */
        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: #f3f4f6;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .file-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            margin-right: 10px;
        }

        .file-size {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* Buttons */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-block {
            display: block;
            width: 100%;
            margin: 20px 0;
        }

        /* Progress */
        .progress-container {
            margin: 30px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            margin-top: 10px;
            text-align: center;
            color: #6b7280;
        }

        /* Results */
        .results {
            margin-top: 30px;
            padding: 25px;
            border-radius: 10px;
            display: none;
        }

        .results.success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
        }

        .results.error {
            background: #fef2f2;
            border: 1px solid #fecaca;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Manifest Preview */
        .manifest-preview {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }

        /* Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
        }

        .setting-item label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #374151;
        }

        .setting-item select,
        .setting-item input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                max-width: none;
                margin-bottom: 5px;
            }
            
            .content-panel {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-panel.active {
            animation: fadeIn 0.3s ease;
        }

        /* Overlay styles */
        .overlay-controls {
            background: #f8faff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .overlay-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .overlay-item input[type="text"] {
            flex: 1;
            margin: 0 10px;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }

        .overlay-item button {
            padding: 8px 15px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🚀 PDF Tools Suite</h1>
            <p>Professional PDF processing for shipping & customs</p>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchPanel('processor')" id="processor-tab">
                📝 Form Processor
            </div>
            <div class="nav-tab" onclick="switchPanel('merger')" id="merger-tab">
                🚢 Document Merger
            </div>
        </div>

        <!-- Form Processor Panel -->
        <div class="content-panel active" id="processor-panel">
            <div class="step active">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Upload PDF Forms</div>
                </div>
                <div class="upload-area" id="processor-upload">
                    <div class="upload-icon">📄</div>
                    <p><strong>Drop your PDF forms here</strong></p>
                    <p>or click to browse files</p>
                    <input type="file" id="processor-files" accept=".pdf" multiple style="display: none;">
                </div>
                <div class="file-list" id="processor-file-list"></div>
            </div>

            <div class="step">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Configure Text Overlays</div>
                </div>
                <div class="overlay-controls">
                    <div id="overlay-list">
                        <!-- Overlay items will be added here -->
                    </div>
                    <button class="btn btn-primary" onclick="addOverlay()">+ Add Text Overlay</button>
                </div>
            </div>

            <div class="step">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Upload Signature (Optional)</div>
                </div>
                <div class="upload-area" id="signature-upload">
                    <div class="upload-icon">✍️</div>
                    <p><strong>Drop signature image here</strong></p>
                    <p>PNG, JPG, or GIF format</p>
                    <input type="file" id="signature-file" accept="image/*" style="display: none;">
                </div>
                <div class="file-list" id="signature-preview"></div>
            </div>

            <button class="btn btn-success btn-block" id="process-forms-btn" onclick="processForms()" disabled>
                🚀 Process Forms
            </button>

            <div class="progress-container" id="processor-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="processor-progress-fill"></div>
                </div>
                <div class="progress-text" id="processor-progress-text">Processing...</div>
            </div>

            <div class="results" id="processor-results">
                <div id="processor-results-content"></div>
            </div>
        </div>

        <!-- Document Merger Panel -->
        <div class="content-panel" id="merger-panel">
            <div class="step active">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Upload EDI File (Optional)</div>
                </div>
                <div class="upload-area" id="edi-upload">
                    <div class="upload-icon">📊</div>
                    <p><strong>Drop your EDI Excel file here</strong></p>
                    <p>Supports .xls and .xlsx files</p>
                    <input type="file" id="edi-file" accept=".xls,.xlsx" style="display: none;">
                </div>
                <div class="file-list" id="edi-file-list"></div>
            </div>

            <div class="step">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Upload PDF Documents</div>
                </div>
                <div class="upload-area" id="merger-upload">
                    <div class="upload-icon">📄</div>
                    <p><strong>Drop your PDF files here</strong></p>
                    <p>Bills of Lading, Advice of Arrivals, Customer Documents</p>
                    <input type="file" id="merger-files" accept=".pdf" multiple style="display: none;">
                </div>
                <div class="file-list" id="merger-file-list"></div>
            </div>

            <div class="step">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Processing Settings</div>
                </div>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label for="naming-format">Output File Naming</label>
                        <select id="naming-format">
                            <option value="name_ref">Name_Reference</option>
                            <option value="ref_name">Reference_Name</option>
                            <option value="name_only">Name Only</option>
                        </select>
                    </div>
                    
                    <div class="setting-item">
                        <label for="page-order">Page Order</label>
                        <select id="page-order">
                            <option value="advice_bill_customer">Advice → Bills → Customer</option>
                            <option value="bill_advice_customer">Bills → Advice → Customer</option>
                            <option value="customer_advice_bill">Customer → Advice → Bills</option>
                        </select>
                    </div>
                    
                    <div class="setting-item">
                        <label for="error-handling">Error Handling</label>
                        <select id="error-handling">
                            <option value="continue">Continue on Errors</option>
                            <option value="stop">Stop on First Error</option>
                            <option value="skip">Skip Problematic Files</option>
                        </select>
                    </div>
                </div>

                <!-- Manifest Preview -->
                <div style="margin-top: 30px;">
                    <h4>Client Manifest Preview</h4>
                    <div class="manifest-preview" id="manifest-preview">
                        <em>Upload an EDI file to see client manifest</em>
                    </div>
                    <button class="btn btn-primary" onclick="downloadManifest()" style="margin-top: 10px;">
                        📥 Download Manifest CSV
                    </button>
                </div>
            </div>

            <button class="btn btn-success btn-block" id="merge-docs-btn" onclick="mergeDocuments()" disabled>
                🚢 Merge Documents
            </button>

            <div class="progress-container" id="merger-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="merger-progress-fill"></div>
                </div>
                <div class="progress-text" id="merger-progress-text">Processing...</div>
            </div>

            <div class="results" id="merger-results">
                <div id="merger-results-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentPanel = 'processor';
        let processorFiles = [];
        let mergerFiles = [];
        let ediFile = null;
        let signatureFile = null;
        let overlays = [];
        let manifestData = {};

        // Panel switching
        function switchPanel(panel) {
            // Update tabs
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(panel + '-tab').classList.add('active');
            
            // Update panels
            document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(panel + '-panel').classList.add('active');
            
            currentPanel = panel;
            
            // Update URL hash
            window.location.hash = panel;
        }

        // File upload setup
        function setupFileUpload(uploadAreaId, fileInputId, fileArray, multiple = true) {
            const uploadArea = document.getElementById(uploadAreaId);
            const fileInput = document.getElementById(fileInputId);

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFileUpload(files, fileArray, multiple);
            });

            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleFileUpload(files, fileArray, multiple);
            });
        }

        function handleFileUpload(files, fileArray, multiple) {
            if (!multiple) {
                fileArray.length = 0; // Clear existing files for single upload
            }
            
            files.forEach(file => {
                if (file.type === 'application/pdf' || 
                    file.name.toLowerCase().endsWith('.pdf') ||
                    file.name.toLowerCase().endsWith('.xls') ||
                    file.name.toLowerCase().endsWith('.xlsx') ||
                    file.type.startsWith('image/')) {
                    
                    fileArray.push({
                        id: Date.now() + Math.random(),
                        file: file,
                        name: file.name,
                        size: file.size
                    });
                }
            });
            
            updateFileDisplay();
            updateButtons();
        }

        function updateFileDisplay() {
            // Update processor files
            updateFileList('processor-file-list', processorFiles);
            
            // Update merger files
            updateFileList('merger-file-list', mergerFiles);
            
            // Update EDI file
            if (ediFile) {
                updateFileList('edi-file-list', [ediFile]);
                processManifest();
            } else {
                document.getElementById('edi-file-list').innerHTML = '';
            }
            
            // Update signature
            if (signatureFile) {
                updateFileList('signature-preview', [signatureFile]);
            } else {
                document.getElementById('signature-preview').innerHTML = '';
            }
        }

        function updateFileList(containerId, files) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            files.forEach((fileObj, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <span class="file-name">${fileObj.name}</span>
                        <span class="file-size">${formatFileSize(fileObj.size)}</span>
                    </div>
                    <button class="remove-btn" onclick="removeFile('${containerId}', ${index})">Remove</button>
                `;
                container.appendChild(fileItem);
            });
        }

        function removeFile(containerId, index) {
            if (containerId === 'processor-file-list') {
                processorFiles.splice(index, 1);
            } else if (containerId === 'merger-file-list') {
                mergerFiles.splice(index, 1);
            } else if (containerId === 'edi-file-list') {
                ediFile = null;
            } else if (containerId === 'signature-preview') {
                signatureFile = null;
            }
            
            updateFileDisplay();
            updateButtons();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateButtons() {
            const processBtn = document.getElementById('process-forms-btn');
            const mergeBtn = document.getElementById('merge-docs-btn');
            
            processBtn.disabled = processorFiles.length === 0;
            mergeBtn.disabled = mergerFiles.length === 0;
        }

        // Overlay management
        function addOverlay() {
            const overlayId = Date.now();
            overlays.push({
                id: overlayId,
                text: '',
                x: 100,
                y: 100
            });
            updateOverlayDisplay();
        }

        function removeOverlay(id) {
            overlays = overlays.filter(o => o.id !== id);
            updateOverlayDisplay();
        }

        function updateOverlayDisplay() {
            const container = document.getElementById('overlay-list');
            container.innerHTML = '';
            
            overlays.forEach(overlay => {
                const overlayItem = document.createElement('div');
                overlayItem.className = 'overlay-item';
                overlayItem.innerHTML = `
                    <label style="min-width: 60px;">Text:</label>
                    <input type="text" value="${overlay.text}" onchange="updateOverlay(${overlay.id}, 'text', this.value)" placeholder="Enter text">
                    <label style="min-width: 30px;">X:</label>
                    <input type="number" value="${overlay.x}" onchange="updateOverlay(${overlay.id}, 'x', this.value)" style="width: 80px;">
                    <label style="min-width: 30px;">Y:</label>
                    <input type="number" value="${overlay.y}" onchange="updateOverlay(${overlay.id}, 'y', this.value)" style="width: 80px;">
                    <button onclick="removeOverlay(${overlay.id})">Remove</button>
                `;
                container.appendChild(overlayItem);
            });
        }

        function updateOverlay(id, field, value) {
            const overlay = overlays.find(o => o.id === id);
            if (overlay) {
                overlay[field] = field === 'text' ? value : parseInt(value);
            }
        }

        // Processing functions
        async function processForms() {
            const processBtn = document.getElementById('process-forms-btn');
            const progressContainer = document.getElementById('processor-progress');
            const progressFill = document.getElementById('processor-progress-fill');
            const progressText = document.getElementById('processor-progress-text');
            const results = document.getElementById('processor-results');

            try {
                processBtn.disabled = true;
                progressContainer.style.display = 'block';
                results.style.display = 'none';

                // Upload files
                progressText.textContent = 'Uploading files...';
                progressFill.style.width = '20%';

                const formData = new FormData();
                processorFiles.forEach(fileObj => {
                    formData.append('files', fileObj.file);
                });

                const uploadResponse = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) throw new Error('Upload failed');

                // Process files
                progressText.textContent = 'Processing forms...';
                progressFill.style.width = '60%';

                const processData = {
                    files: processorFiles.map(f => ({ originalName: f.name })),
                    overlays: overlays,
                    signature: signatureFile ? signatureFile.name : null
                };

                const processResponse = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(processData)
                });

                if (!processResponse.ok) throw new Error('Processing failed');

                const result = await processResponse.json();

                progressText.textContent = 'Complete!';
                progressFill.style.width = '100%';

                setTimeout(() => {
                    displayProcessorResults(result);
                    progressContainer.style.display = 'none';
                }, 1000);

            } catch (error) {
                displayError('processor-results', error.message);
                progressContainer.style.display = 'none';
            } finally {
                processBtn.disabled = false;
            }
        }

        async function mergeDocuments() {
            const mergeBtn = document.getElementById('merge-docs-btn');
            const progressContainer = document.getElementById('merger-progress');
            const progressFill = document.getElementById('merger-progress-fill');
            const progressText = document.getElementById('merger-progress-text');
            const results = document.getElementById('merger-results');

            try {
                mergeBtn.disabled = true;
                progressContainer.style.display = 'block';
                results.style.display = 'none';

                // Upload files
                progressText.textContent = 'Uploading files...';
                progressFill.style.width = '25%';

                const formData = new FormData();
                mergerFiles.forEach(fileObj => {
                    formData.append('pdfFiles', fileObj.file);
                });
                if (ediFile) {
                    formData.append('ediFile', ediFile.file);
                }

                const uploadResponse = await fetch('/api/merger/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) throw new Error('Upload failed');

                // Process manifest
                progressText.textContent = 'Processing manifest...';
                progressFill.style.width = '50%';

                // Process documents
                progressText.textContent = 'Merging documents...';
                progressFill.style.width = '75%';

                const processData = {
                    files: { pdfFiles: mergerFiles.map(f => ({ originalName: f.name })) },
                    settings: {
                        namingFormat: document.getElementById('naming-format').value,
                        pageOrder: document.getElementById('page-order').value,
                        errorHandling: document.getElementById('error-handling').value
                    }
                };

                const processResponse = await fetch('/api/merger/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(processData)
                });

                if (!processResponse.ok) throw new Error('Processing failed');

                const result = await processResponse.json();

                progressText.textContent = 'Complete!';
                progressFill.style.width = '100%';

                setTimeout(() => {
                    displayMergerResults(result);
                    progressContainer.style.display = 'none';
                }, 1000);

            } catch (error) {
                displayError('merger-results', error.message);
                progressContainer.style.display = 'none';
            } finally {
                mergeBtn.disabled = false;
            }
        }

        // Display results
        function displayProcessorResults(result) {
            const results = document.getElementById('processor-results');
            const content = document.getElementById('processor-results-content');
            
            results.className = 'results success';
            results.style.display = 'block';

            content.innerHTML = `
                <h3 style="color: #059669; margin-bottom: 20px;">✅ Processing Complete!</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" style="color: #10b981;">${result.processedFiles?.length || 0}</div>
                        <div class="stat-label">Files Processed</div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="window.open('${result.downloadUrl}', '_blank')">
                    📥 Download Processed Files
                </button>
            `;
        }

        function displayMergerResults(result) {
            const results = document.getElementById('merger-results');
            const content = document.getElementById('merger-results-content');
            
            results.className = 'results success';
            results.style.display = 'block';

            content.innerHTML = `
                <h3 style="color: #059669; margin-bottom: 20px;">🚢 Merging Complete!</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" style="color: #10b981;">${result.files_processed || 0}</div>
                        <div class="stat-label">Files Processed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #3b82f6;">${result.unique_clients_found || 0}</div>
                        <div class="stat-label">Unique Clients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #8b5cf6;">${result.clients_merged_successfully || 0}</div>
                        <div class="stat-label">Successfully Merged</div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="window.open('${result.downloadUrl}', '_blank')">
                    📥 Download Merged Documents
                </button>
            `;
        }

        function displayError(resultsId, message) {
            const results = document.getElementById(resultsId);
            const content = results.querySelector('div');
            
            results.className = 'results error';
            results.style.display = 'block';

            content.innerHTML = `
                <h3 style="color: #dc2626; margin-bottom: 15px;">❌ Error</h3>
                <p>${message}</p>
                <button class="btn btn-primary" onclick="location.reload()">🔄 Try Again</button>
            `;
        }

        // Manifest functions
        async function processManifest() {
            if (!ediFile) return;

            try {
                // Simulate manifest processing
                manifestData = {
                    '000/531/023': 'Bruce De Clifford Mastoroudes',
                    '000/531/318': 'Kelly Anne Rush',
                    '000/532/934': 'Otto Wipplinger',
                    '000/533/012': 'Ockert Cornelius Du toit',
                    '000/533/413': 'Jonathan Dominique Van Belle'
                };

                updateManifestPreview();
            } catch (error) {
                console.error('Manifest processing error:', error);
            }
        }

        function updateManifestPreview() {
            const preview = document.getElementById('manifest-preview');
            
            if (Object.keys(manifestData).length === 0) {
                preview.innerHTML = '<em>Upload an EDI file to see client manifest</em>';
                return;
            }

            const entries = Object.entries(manifestData).slice(0, 10);
            preview.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 10px;">Reference → Name</div>
                ${entries.map(([ref, name]) => `<div>${ref} → ${name}</div>`).join('')}
                ${Object.keys(manifestData).length > 10 ? 
                    `<div style="margin-top: 10px; font-style: italic;">... and ${Object.keys(manifestData).length - 10} more entries</div>` : 
                    ''
                }
            `;
        }

        function downloadManifest() {
            if (Object.keys(manifestData).length === 0) {
                alert('No manifest data available. Please upload an EDI file first.');
                return;
            }

            const csv = 'ConsigneeRef,FullName\n' + 
                Object.entries(manifestData)
                    .map(([ref, name]) => `${ref},${name}`)
                    .join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'client_manifest.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Setup file uploads
            setupFileUpload('processor-upload', 'processor-files', processorFiles);
            setupFileUpload('merger-upload', 'merger-files', mergerFiles);
            setupFileUpload('edi-upload', 'edi-file', [ediFile], false);
            setupFileUpload('signature-upload', 'signature-file', [signatureFile], false);

            // Handle EDI file upload separately
            document.getElementById('edi-file').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    ediFile = {
                        id: Date.now(),
                        file: e.target.files[0],
                        name: e.target.files[0].name,
                        size: e.target.files[0].size
                    };
                    updateFileDisplay();
                }
            });

            // Handle signature upload separately
            document.getElementById('signature-file').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    signatureFile = {
                        id: Date.now(),
                        file: e.target.files[0],
                        name: e.target.files[0].name,
                        size: e.target.files[0].size
                    };
                    updateFileDisplay();
                }
            });

            // Handle URL hash
            if (window.location.hash === '#merger') {
                switchPanel('merger');
            }

            console.log('🚀 PDF Tools Suite initialized!');
        });
    </script>
</body>
</html>
